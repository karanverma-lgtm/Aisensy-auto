name: Send Campaign

on:
  workflow_dispatch:
    inputs:
      csv_path:
        description: 'Path to CSV file'
        required: false
        default: 'users.csv'
      limit:
        description: 'Limit number of rows to process (empty = all)'
        required: false
        default: ''
      test_number:
        description: 'If set, only send to this number (normalized)'
        required: false
        default: ''
      output:
        description: 'Results output file'
        required: false
        default: 'results.csv'

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv
      - name: Run live send
        env:
          AISENSY_API_KEY: ${{ secrets.AISENSY_API_KEY != '' && secrets.AISENSY_API_KEY || vars.AISENSY_API_KEY }}
        run: |
          args="--delay 0.3 --output \"${{ github.event.inputs.output }}\""
          if [ -n "${{ github.event.inputs.limit }}" ]; then args="$args --limit ${{ github.event.inputs.limit }}"; fi
          if [ -n "${{ github.event.inputs.test_number }}" ]; then args="$args --test-number '${{ github.event.inputs.test_number }}'"; fi
          python send_campaign.py "${{ github.event.inputs.csv_path }}" $args
        shell: bash
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results
          path: ${{ github.event.inputs.output }}
