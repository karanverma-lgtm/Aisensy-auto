name: Send Campaign

on:
  workflow_dispatch:
    inputs:
      csv_path:
        description: 'Path to CSV file'
        required: false
        default: 'users.csv'
      limit:
        description: 'Limit number of rows to process (empty = all)'
        required: false
        default: ''
      test_number:
        description: 'If set, only send to this number (normalized)'
        required: false
        default: ''
      output:
        description: 'Results output file'
        required: false
        default: 'results.csv'
  schedule:
    # 3:30 PM IST = 10:00 AM UTC
    - cron: '25 10 * * *'

jobs:
  send:
    runs-on: ubuntu-latest
    env:
      CSV_PATH: ${{ github.event.inputs.csv_path || 'users.csv' }}
      OUTPUT: ${{ github.event.inputs.output || 'results.csv' }}
      LIMIT: ${{ github.event.inputs.limit || '' }}
      TEST_NUMBER: ${{ github.event.inputs.test_number || '' }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv
      - name: Run live send
        env:
          AISENSY_API_KEY: ${{ secrets.AISENSY_API_KEY != '' && secrets.AISENSY_API_KEY || vars.AISENSY_API_KEY }}
        run: |
          args="--delay 0.3 --output \"${OUTPUT}\""
          if [ -n "${LIMIT}" ]; then args="$args --limit ${LIMIT}"; fi
          if [ -n "${TEST_NUMBER}" ]; then args="$args --test-number '${TEST_NUMBER}'"; fi
          python send_campaign.py "${CSV_PATH}" $args
        shell: bash
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results
          path: ${{ env.OUTPUT }}
